// Schema Prisma cho h·ªá th·ªëng LMS
// T·ªëi ∆∞u h√≥a cho x√°c th·ª±c credentials v√† qu·∫£n l√Ω phi√™n l√†m vi·ªác

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// Enum cho vai tr√≤ ng∆∞·ªùi d√πng
enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

// Ki·ªÉu b√†i t·∫≠p
enum AssignmentType {
  ESSAY
  QUIZ
}

// Ki·ªÉu c√¢u h·ªèi tr·∫Øc nghi·ªám
enum QuestionType {
  ESSAY
  SINGLE
  MULTIPLE
}

// Tr·∫°ng th√°i ki·ªÉm duy·ªát
enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Model User - Qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng
model User {
  // Th√¥ng tin x√°c th·ª±c
  id       String @id @default(cuid())
  email    String @unique // Email d√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p
  password String // M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c m√£ h√≥a

  // Th√¥ng tin c√° nh√¢n
  fullname String // H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß
  role     UserRole @default(STUDENT) // Vai tr√≤ ng∆∞·ªùi d√πng

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá
  sessions           Session[]
  teacherClassrooms  Classroom[]            @relation("TeacherClassrooms") // L·ªõp h·ªçc m√† gi√°o vi√™n t·∫°o
  studentClassrooms  ClassroomStudent[] // L·ªõp h·ªçc m√† h·ªçc sinh tham gia
  createdCourses     Course[] // Kh√≥a h·ªçc ƒë∆∞·ª£c t·∫°o b·ªüi gi√°o vi√™n
  submissions        AssignmentSubmission[] // B√†i n·ªôp c·ªßa h·ªçc sinh
  createdAssignments Assignment[] // B√†i t·∫≠p ƒë∆∞·ª£c t·∫°o b·ªüi gi√°o vi√™n
  questionComments   QuestionComment[] // B√¨nh lu·∫≠n c·ªßa ng∆∞·ªùi d√πng ·ªü c√¢u h·ªèi

  // Back-relations b·ªï sung
  assignmentFilesUploaded         AssignmentFile[]
  announcementsAuthored           Announcement[]
  announcementCommentsAuthored    AnnouncementComment[]
  announcementAttachmentsUploaded AnnouncementAttachment[]

  // Back-relations cho t·ªï ch·ª©c v√† audit
  organizationMemberships OrganizationMember[]
  auditLogs               AuditLog[]

  // Quan h·ªá ph·ª• huynh-h·ªçc sinh
  parentRelations  ParentStudent[] @relation("ParentRelations")
  studentRelations ParentStudent[] @relation("StudentRelations")

  // Self-service linking relations
  studentInvitations     ParentStudentInvitation[] @relation("StudentInvitations")
  parentInvitations      ParentStudentInvitation[] @relation("ParentInvitations")
  parentLinkRequests     ParentStudentLinkRequest[] @relation("ParentLinkRequests")
  studentLinkRequests    ParentStudentLinkRequest[] @relation("StudentLinkRequests")

  @@map("users")
}

// Model Session - Qu·∫£n l√Ω phi√™n ƒëƒÉng nh·∫≠p
model Session {
  // Th√¥ng tin phi√™n
  id           String   @id @default(cuid())
  sessionToken String   @unique
  expires      DateTime

  // Quan h·ªá v·ªõi User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Model PasswordReset - Qu·∫£n l√Ω y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
model PasswordReset {
  // Th√¥ng tin token reset
  id        String   @id @default(cuid())
  email     String // Email c·ªßa ng∆∞·ªùi d√πng y√™u c·∫ßu reset
  token     String   @unique // M√£ x√°c th·ª±c 6 s·ªë
  expires   DateTime // Th·ªùi gian h·∫øt h·∫°n c·ªßa m√£
  completed Boolean  @default(false) // Tr·∫°ng th√°i ƒë√£ reset password ch∆∞a

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("password_resets")
}

// Model Classroom - Qu·∫£n l√Ω th√¥ng tin l·ªõp h·ªçc
model Classroom {
  id          String  @id @default(cuid())
  name        String // T√™n l·ªõp h·ªçc
  description String? // M√¥ t·∫£ v·ªÅ l·ªõp h·ªçc
  code        String  @unique // M√£ l·ªõp h·ªçc ƒë·ªÉ h·ªçc sinh tham gia
  icon        String  @default("üìö") // Icon c·ªßa l·ªõp h·ªçc
  maxStudents Int     @default(30) // S·ªë l∆∞·ª£ng h·ªçc sinh t·ªëi ƒëa
  isActive    Boolean @default(true) // Tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa l·ªõp

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // R√†ng bu·ªôc t·ªï ch·ª©c
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Quan h·ªá v·ªõi gi√°o vi√™n t·∫°o l·ªõp
  teacherId String
  teacher   User   @relation("TeacherClassrooms", fields: [teacherId], references: [id])

  // Quan h·ªá v·ªõi h·ªçc sinh trong l·ªõp, kh√≥a h·ªçc v√† b√†i t·∫≠p
  students      ClassroomStudent[]
  courses       ClassroomCourse[]
  assignments   AssignmentClassroom[] // C√°c b√†i t·∫≠p ƒë∆∞·ª£c th√™m v√†o l·ªõp
  announcements Announcement[]

  @@index([teacherId]) // Index cho query classrooms c·ªßa teacher
  @@index([organizationId, createdAt])
  @@map("classrooms")
}

// Model Course - Qu·∫£n l√Ω kh√≥a h·ªçc
model Course {
  id          String  @id @default(cuid())
  title       String // T√™n kh√≥a h·ªçc
  description String? // M√¥ t·∫£ kh√≥a h·ªçc
  coverImage  String? // ·∫¢nh b√¨a kh√≥a h·ªçc

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá
  authorId    String
  author      User              @relation(fields: [authorId], references: [id])
  classrooms  ClassroomCourse[] // C√°c l·ªõp h·ªçc c√≥ kh√≥a h·ªçc n√†y
  lessons     Lesson[] // C√°c b√†i h·ªçc trong kh√≥a
  assignments Assignment[] // C√°c b√†i t·∫≠p trong kh√≥a

  // R√†ng bu·ªôc t·ªï ch·ª©c
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt])
  @@map("courses")
}

// Model Lesson - Qu·∫£n l√Ω b√†i h·ªçc
model Lesson {
  id      String @id @default(cuid())
  title   String // Ti√™u ƒë·ªÅ b√†i h·ªçc
  content String @db.Text // N·ªôi dung b√†i h·ªçc
  order   Int // Th·ª© t·ª± b√†i h·ªçc trong kh√≥a

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá v·ªõi kh√≥a h·ªçc
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("lessons")
}

// Model Assignment - Qu·∫£n l√Ω b√†i t·∫≠p
model Assignment {
  id               String         @id @default(cuid())
  title            String // Ti√™u ƒë·ªÅ b√†i t·∫≠p
  description      String?        @db.Text // M√¥ t·∫£ b√†i t·∫≠p
  dueDate          DateTime? // H·∫°n n·ªôp b√†i
  // Th·ªùi gian m·ªü/kho√° v√† gi·ªõi h·∫°n th·ªùi gian l√†m b√†i (ph√∫t)
  openAt           DateTime?
  lockAt           DateTime?
  timeLimitMinutes Int?
  type             AssignmentType @default(ESSAY)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá
  authorId    String
  author      User                   @relation(fields: [authorId], references: [id])
  courseId    String?
  course      Course?                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions   Question[]
  submissions AssignmentSubmission[] // C√°c b√†i n·ªôp c·ªßa h·ªçc sinh
  classrooms  AssignmentClassroom[] // C√°c l·ªõp h·ªçc c√≥ b√†i t·∫≠p n√†y
  files       AssignmentFile[] // T√†i li·ªáu/ƒë√≠nh k√®m c·ªßa b√†i t·∫≠p

  // R√†ng bu·ªôc t·ªï ch·ª©c (t√πy ch·ªçn, ph·ª•c v·ª• l·ªçc nhanh theo org)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([authorId]) // Index cho query assignments c·ªßa teacher
  @@index([authorId, createdAt]) // Composite index cho teacher queries v·ªõi sorting
  @@index([dueDate]) // Index cho query assignments theo deadline
  @@index([organizationId, createdAt])
  @@map("assignments")
}

// C√¢u h·ªèi tr·∫Øc nghi·ªám
model Question {
  id      String       @id @default(cuid())
  content String       @db.Text
  type    QuestionType @default(SINGLE)
  order   Int

  assignmentId String
  assignment   Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  options      Option[]
  comments     QuestionComment[]

  @@index([assignmentId, order]) // Composite index cho query questions theo assignment v√† order
  @@map("questions")
}

// Ph∆∞∆°ng √°n tr·∫£ l·ªùi c·ªßa c√¢u h·ªèi tr·∫Øc nghi·ªám
model Option {
  id        String  @id @default(cuid())
  label     String
  content   String  @db.Text
  isCorrect Boolean @default(false)
  order     Int

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

// B√¨nh lu·∫≠n ·ªü t·ª´ng c√¢u h·ªèi
model QuestionComment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([questionId, createdAt]) // Composite index cho pagination comments (sort by createdAt desc)
  @@map("question_comments")
}

// Model AssignmentSubmission - Qu·∫£n l√Ω b√†i n·ªôp
model AssignmentSubmission {
  id          String   @id @default(cuid())
  content     String   @db.Text // N·ªôi dung b√†i n·ªôp
  grade       Float? // ƒêi·ªÉm s·ªë
  feedback    String? // Nh·∫≠n x√©t c·ªßa gi√°o vi√™n
  submittedAt DateTime @default(now())
  attempt     Int      @default(1)

  // Quan h·ªá
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId    String
  student      User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId, attempt])
  @@index([assignmentId, studentId]) // Index ph·ª• cho lookup nhanh
  @@index([studentId, submittedAt]) // Index cho grades queries (sort by submittedAt)
  @@map("assignment_submissions")
}

// Model ClassroomStudent - Quan h·ªá nhi·ªÅu-nhi·ªÅu gi·ªØa Classroom v√† Student
model ClassroomStudent {
  id       String   @id @default(cuid())
  joinedAt DateTime @default(now())

  // Quan h·ªá
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classroomId, studentId])
  @@index([studentId]) // Index cho query classrooms c·ªßa student
  @@index([studentId, joinedAt]) // Composite index cho student queries s·∫Øp x·∫øp theo th·ªùi gian tham gia
  @@index([classroomId]) // Index cho query students c·ªßa classroom
  @@map("classroom_students")
}

// Model ClassroomCourse - Quan h·ªá nhi·ªÅu-nhi·ªÅu gi·ªØa Classroom v√† Course
model ClassroomCourse {
  id      String   @id @default(cuid())
  addedAt DateTime @default(now())

  // Quan h·ªá
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([classroomId, courseId])
  @@map("classroom_courses")
}

// Model AssignmentClassroom - Quan h·ªá nhi·ªÅu-nhi·ªÅu gi·ªØa Assignment v√† Classroom
// Cho ph√©p m·ªôt b√†i t·∫≠p ƒë∆∞·ª£c th√™m v√†o nhi·ªÅu l·ªõp h·ªçc
model AssignmentClassroom {
  id      String   @id @default(cuid())
  addedAt DateTime @default(now()) // Th·ªùi gian th√™m b√†i t·∫≠p v√†o l·ªõp

  // Quan h·ªá
  classroomId  String
  classroom    Classroom  @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([classroomId, assignmentId]) // M·ªôt b√†i t·∫≠p ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c th√™m v√†o m·ªôt l·ªõp m·ªôt l·∫ßn
  @@index([assignmentId]) // Index cho query assignments theo assignmentId
  @@index([classroomId]) // Index cho query assignments theo classroomId
  @@index([classroomId, addedAt]) // Composite index cho queries s·∫Øp x·∫øp theo th·ªùi gian th√™m
  @@map("assignment_classrooms")
}

// Model AssignmentFile - L∆∞u metadata file ƒë∆∞·ª£c upload l√™n Supabase Storage
model AssignmentFile {
  id        String   @id @default(cuid())
  name      String // T√™n file g·ªëc ƒë·ªÉ hi·ªÉn th·ªã
  path      String // ƒê∆∞·ªùng d·∫´n trong bucket
  size      Int // Byte
  mimeType  String // Mime type l∆∞u ƒë·ªÉ ph·ª•c v·ª• header t·∫£i xu·ªëng
  createdAt DateTime @default(now())

  // Quan h·ªá
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User       @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([createdAt])
  @@map("assignment_files")
}

// Th√¥ng b√°o (announcement) trong l·ªõp h·ªçc
model Announcement {
  id        String   @id @default(cuid())
  content   String   @db.Text // N·ªôi dung th√¥ng b√°o
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Ki·ªÉm duy·ªát n·ªôi dung
  status           ModerationStatus @default(APPROVED)
  moderatedById    String?
  moderatedAt      DateTime?
  moderationReason String?

  // Quan h·ªá
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  authorId    String
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  comments    AnnouncementComment[]
  attachments AnnouncementAttachment[]

  // R√†ng bu·ªôc t·ªï ch·ª©c (denormalized ƒë·ªÉ l·ªçc nhanh)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([classroomId, createdAt]) // Query th√¥ng b√°o theo l·ªõp, newest-first
  @@index([authorId])
  @@index([status, createdAt])
  @@index([organizationId, createdAt])
  @@map("announcements")
}

// B√¨nh lu·∫≠n cho th√¥ng b√°o
model AnnouncementComment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Ki·ªÉm duy·ªát n·ªôi dung
  status           ModerationStatus @default(APPROVED)
  moderatedById    String?
  moderatedAt      DateTime?
  moderationReason String?

  // Quan h·ªá
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  authorId       String
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // H·ªó tr·ª£ nested comments (reply)
  parentId String?
  parent   AnnouncementComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  AnnouncementComment[] @relation("CommentReplies")

  @@index([announcementId, createdAt]) // Ph·ª•c v·ª• pagination b√¨nh lu·∫≠n
  @@index([authorId])
  @@index([parentId]) // Index cho query replies
  @@index([status, createdAt])
  @@map("announcement_comments")
}

// File ƒë√≠nh k√®m cho th√¥ng b√°o (l∆∞u ·ªü bucket Supabase "lessons")
model AnnouncementAttachment {
  id        String   @id @default(cuid())
  name      String // T√™n file hi·ªÉn th·ªã
  path      String // ƒê∆∞·ªùng d·∫´n trong bucket
  size      Int
  mimeType  String
  createdAt DateTime @default(now())

  // Quan h·ªá
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  uploadedById   String
  uploadedBy     User         @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([createdAt])
  @@index([announcementId, createdAt])
  @@map("announcement_attachments")
}

// N·ªôp b√†i t·ª± lu·∫≠n b·∫±ng file (Supabase Storage)
model Submission {
  id           String   @id @default(cuid())
  assignmentId String
  studentId    String
  status       String   @default("submitted")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  files SubmissionFile[]

  @@index([assignmentId, studentId])
  @@map("submissions")
}

model SubmissionFile {
  id           String     @id @default(cuid())
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  fileName     String
  mimeType     String
  sizeBytes    Int
  storagePath  String // submissions/{assignmentId}/{studentId}/{uuid}-{fileName}
  createdAt    DateTime   @default(now())

  @@index([submissionId])
  @@map("submission_files")
}

// =============================================
// Ph√¢n quy·ªÅn theo t·ªï ch·ª©c v√† nh·∫≠t k√Ω thao t√°c
// =============================================

// Tr·∫°ng th√°i c·ªßa t·ªï ch·ª©c
enum OrganizationStatus {
  ACTIVE
  INACTIVE
}

// T·ªï ch·ª©c/ƒë∆°n v·ªã qu·∫£n l√Ω (t√πy ch·ªçn c√≥ th·ªÉ ch·ªâ d√πng 1 b·∫£n ghi m·∫∑c ƒë·ªãnh)
model Organization {
  id        String             @id @default(cuid())
  name      String
  slug      String?            @unique
  status    OrganizationStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Quan h·ªá
  members       OrganizationMember[]
  classrooms    Classroom[]
  courses       Course[]
  assignments   Assignment[]
  announcements Announcement[]
  auditLogs     AuditLog[]

  @@map("organizations")
}

// Th√†nh vi√™n thu·ªôc m·ªôt Organization (map ng∆∞·ªùi d√πng v√†o t·ªï ch·ª©c)
model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  roleInOrg      String?
  createdAt      DateTime @default(now())

  // Quan h·ªá
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId], name: "organizationId_userId")
  @@index([userId])
  @@index([organizationId, createdAt])
  @@map("organization_members")
}

// Nh·∫≠t k√Ω thao t√°c ƒë·ªÉ ph·ª•c v·ª• audit v√† truy v·∫øt
model AuditLog {
  id             String   @id @default(cuid())
  actorId        String
  actorRole      String?
  action         String
  entityType     String
  entityId       String
  metadata       Json?
  ip             String?
  userAgent      String?
  organizationId String?
  createdAt      DateTime @default(now())

  // Quan h·ªá
  actor        User          @relation(fields: [actorId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([actorId, createdAt])
  @@index([entityType, entityId])
  @@index([organizationId, createdAt])
  @@map("audit_logs")
}

// Enum cho tr·∫°ng th√°i li√™n k·∫øt ph·ª• huynh-h·ªçc sinh
enum LinkStatus {
  PENDING
  ACTIVE
  REJECTED
  EXPIRED
}

// Enum cho tr·∫°ng th√°i y√™u c·∫ßu li√™n k·∫øt
enum LinkRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// Model ParentStudent - Quan h·ªá nhi·ªÅu-nhi·ªÅu gi·ªØa Parent v√† Student
// Cho ph√©p ph·ª• huynh theo d√µi t√¨nh h√¨nh h·ªçc t·∫≠p c·ªßa con m√¨nh
model ParentStudent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Quan h·ªá
  parentId String
  parent   User @relation("ParentRelations", fields: [parentId], references: [id], onDelete: Cascade)

  studentId String
  student   User @relation("StudentRelations", fields: [studentId], references: [id], onDelete: Cascade)

  // Self-service linking fields
  status              LinkStatus @default(ACTIVE)
  parentConfirmedAt   DateTime?
  studentConfirmedAt  DateTime?
  initiatedBy         String?    // User ID c·ªßa ng∆∞·ªùi kh·ªüi t·∫°o li√™n k·∫øt
  metadata            Json?      // Th√¥ng tin b·ªï sung (source, notes, etc.)

  @@unique([parentId, studentId], name: "parentId_studentId")
  @@index([parentId])
  @@index([studentId])
  @@index([status])
  @@index([status, createdAt])
  @@map("parent_students")
}

// Model cho invitation codes t·ª´ h·ªçc sinh
model ParentStudentInvitation {
  id        String            @id @default(cuid())
  code      String            @unique // M√£ m·ªùi 8 k√Ω t·ª±
  status    LinkRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  expiresAt DateTime // H·∫øt h·∫°n sau 7 ng√†y
  usedAt    DateTime? // Th·ªùi ƒëi·ªÉm ƒë∆∞·ª£c s·ª≠ d·ª•ng

  // Quan h·ªá
  studentId String
  student   User   @relation("StudentInvitations", fields: [studentId], references: [id], onDelete: Cascade)

  parentId String? // Null cho ƒë·∫øn khi ƒë∆∞·ª£c accept
  parent   User?   @relation("ParentInvitations", fields: [parentId], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([code])
  @@index([status])
  @@index([expiresAt])
  @@map("parent_student_invitations")
}

// Model cho link requests t·ª´ ph·ª• huynh
model ParentStudentLinkRequest {
  id          String            @id @default(cuid())
  status      LinkRequestStatus @default(PENDING)
  message     String? // L·ªùi nh·∫Øn t·ª´ ph·ª• huynh
  createdAt   DateTime          @default(now())
  respondedAt DateTime? // Th·ªùi ƒëi·ªÉm h·ªçc sinh ph·∫£n h·ªìi
  expiresAt   DateTime // H·∫øt h·∫°n sau 30 ng√†y

  // Quan h·ªá
  parentId String
  parent   User   @relation("ParentLinkRequests", fields: [parentId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentLinkRequests", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId]) // M·ªôt ph·ª• huynh ch·ªâ c√≥ th·ªÉ g·ª≠i 1 request ƒë·∫øn 1 h·ªçc sinh
  @@index([parentId])
  @@index([studentId])
  @@index([status])
  @@index([expiresAt])
  @@map("parent_student_link_requests")
}

// C√†i ƒë·∫∑t h·ªá th·ªëng d·∫°ng key/value (JSON) cho feature flags, maintenance, upload limits...
model SystemSetting {
  key       String   @id
  value     Json?
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
