@startuml seq-reset-password
title Sequence - Quên mật khẩu (send-code / verify / reset)

actor "Guest/User" as U
participant "Web UI\nResetPassword" as UI
participant "API\nPOST /api/auth/reset-password/send-code" as SendAPI
participant "API\nPOST /api/auth/reset-password/verify-code" as VerifyAPI
participant "API\nPOST /api/auth/reset-password/reset" as ResetAPI
participant "DB (Prisma)\nPasswordReset + User" as DB
participant "Email Service" as Email
participant "AuditLog" as Audit

U -> UI : Nhập email
UI -> SendAPI : POST {email}
SendAPI -> DB : find user by email\n(deleteMany old reset)\ncreate PasswordReset(token,expires)
SendAPI -> Email : send token (6 digits)
SendAPI -> Audit : write PASSWORD_RESET_SEND_CODE
SendAPI --> UI : 200 (không tiết lộ email tồn tại)

U -> UI : Nhập token
UI -> VerifyAPI : POST {email,token}
VerifyAPI -> DB : find PasswordReset(valid,not completed)
VerifyAPI --> UI : ok/fail

U -> UI : Nhập mật khẩu mới
UI -> ResetAPI : POST {email,token,password}
ResetAPI -> DB : transaction\nupdate User.password\nupdate PasswordReset.completed=true
ResetAPI -> Audit : write PASSWORD_RESET_COMPLETED
ResetAPI --> UI : success

@enduml