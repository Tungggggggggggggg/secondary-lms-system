@startuml flow-rag
title Quy trình RAG Tutor (Activity)

start
:Student gửi câu hỏi;
:API xác thực role STUDENT;
:Kiểm tra membership lớp;
:Rate limit (IP + user);
:Tạo embedding câu hỏi
(Gemini Embedding - RETRIEVAL_QUERY);
:Truy vấn pgvector lấy Top-k chunk gần nhất;
if (Có chunk phù hợp?) then (Có)
  :Tạo prompt từ chunks + chat history;
  :Gọi Gemini generateContent;
  :Trả về answer + sources;
else (Không)
  :Trả về thông báo chưa có embedding;
  :Set cờ noEmbeddings;
endif
stop

@enduml
