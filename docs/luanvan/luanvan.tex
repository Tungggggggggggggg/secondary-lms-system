\documentclass[12pt, a4paper]{report}

% --- UNIVERSAL PREAMBLE BLOCK FOR VIETNAMESE ---
\usepackage[a4paper, top=20mm, bottom=20mm, left=35mm, right=20mm]{geometry}
\usepackage{fontspec}
\usepackage[bidi=basic, provide=*]{babel}

% Cấu hình ngôn ngữ và font chữ (Sử dụng Noto Serif để thay thế Times New Roman trong môi trường này)
\babelprovide[main, import, onchar=ids fonts]{vietnamese}
\babelprovide[import, onchar=ids fonts]{english}

\IfFontExistsTF{Noto Serif}{
\babelfont{rm}{Noto Serif}
\babelfont[vietnamese]{rm}{Noto Serif}
}{
\IfFontExistsTF{Times New Roman}{
\babelfont{rm}{Times New Roman}
\babelfont[vietnamese]{rm}{Times New Roman}
}{
\babelfont{rm}{Latin Modern Roman}
\babelfont[vietnamese]{rm}{Latin Modern Roman}
}
}

% Fix cho danh sách khi sử dụng ngôn ngữ không phải tiếng Anh
\usepackage{enumitem}
\setlist[itemize]{label=-}
% --- GÓI BỔ TRỢ HỌC THUẬT ---
\usepackage{amsmath, amsfonts, amssymb}
\usepackage{graphicx}
\graphicspath{{docs/luanvan/}{docs/luanvan/figures/}{docs/luanvan/figures/uml/}{figures/}{figures/uml/}{uml/}{out/docs/luanvan/figures/}{out/docs/luanvan/figures/uml/}{out/docs/luanvan/figures/uml/usecase-overall/}{out/docs/luanvan/figures/uml/usecase-anti-cheat/}{out/docs/luanvan/figures/uml/sequence-exam-events/}{out/docs/luanvan/figures/uml/activity-suspicious-behavior/}{out/docs/luanvan/figures/uml/context-eduverse/}{out/docs/luanvan/figures/uml/component-architecture/}{out/docs/luanvan/figures/uml/db-core/}}
\usepackage{setspace}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{listings}
\usepackage{color}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{float}
\usepackage{needspace}

% Cấu hình giãn dòng chuẩn luận văn (1.5 line spacing)
\onehalfspacing
\setlength{\parindent}{1.27cm}
\setlength{\emergencystretch}{2em}

% Cấu hình mã nguồn (Code) chuyên nghiệp
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstset{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

% Định dạng tiêu đề chương theo chuẩn: CHƯƠNG 1 (Căn giữa, viết hoa)
\titleformat{\chapter}[display]
  {\normalfont\large\bfseries\centering}
  {\MakeUppercase{\chaptername}\ \thechapter}
  {5pt}
  {\large\MakeUppercase}
\titlespacing*{\chapter}{0pt}{-20pt}{30pt}

% Định dạng tiêu đề mục (Section, Subsection)
\titleformat{\section}{\normalfont\normalsize\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\normalsize\bfseries\itshape}{\thesubsection}{1em}{}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,      
    urlcolor=blue,
    pdftitle={Luận văn Tốt nghiệp - Smart LMS},
}

\begin{document}

% ======================================================
% TRANG BÌA
% ======================================================
\begin{titlepage}
    \centering
    {\large \textbf{BỘ GIÁO DỤC VÀ ĐÀO TẠO}} \\
    {\large \textbf{TRƯỜNG ĐẠI HỌC GIAO THÔNG VẬN TẢI TP.HCM}} \\
    {\large \textbf{KHOA CÔNG NGHỆ THÔNG TIN}}
    
    \vspace{1.5cm}
    \begin{figure}[h]
      \centering
      \IfFileExists{docs/luanvan/figures/uth-logo.png}{
        \includegraphics[width=0.35\textwidth]{docs/luanvan/figures/uth-logo.png}
      }{
        \IfFileExists{figures/uth-logo.png}{
          \includegraphics[width=0.35\textwidth]{figures/uth-logo.png}
        }{
          \framebox{\parbox{0.35\textwidth}{\centering
            \vspace{1cm}
            \textbf{LOGO TRƯỜNG} \\
            \small\textit{(Image Placeholder)}
            \vspace{1cm}
          }}
        }
      }
    \end{figure}
    
    \vspace{1.5cm}
    {\Large \textbf{LUẬN VĂN TỐT NGHIỆP ĐẠI HỌC}} \\
    
    \vspace{1cm}
    \begin{spacing}{1.5}
        {\huge \textbf{NGHIÊN CỨU VÀ XÂY DỰNG HỆ THỐNG QUẢN LÝ HỌC TẬP THÔNG MINH (SMART LMS) DỰA TRÊN KIẾN TRÚC RAG VÀ MÔ HÌNH NGÔN NGỮ LỚN}}
    \end{spacing}
    
    \vspace{2cm}
    \begin{flushright}
        \begin{tabular}{l p{6cm}}
            \textbf{Giảng viên hướng dẫn:} & \textbf{TS. Nguyễn Văn B} \\
            \textbf{Sinh viên thực hiện:}     & \textbf{Nguyễn Quốc Tùnggggg} \\
            \textbf{Mã số sinh viên:}         & \textbf{2251120259} \\
            \textbf{Lớp:}                     & \textbf{CN22E}
        \end{tabular}
    \end{flushright}

    \vfill
    {\large \textbf{TP. HỒ CHÍ MINH, NĂM 2025}}
\end{titlepage}

% ======================================================
% PHẦN TRƯỚC NỘI DUNG CHÍNH
% ======================================================
\pagenumbering{roman}

\chapter*{Lời cam đoan}
\addcontentsline{toc}{chapter}{Lời cam đoan}
Tôi xin cam đoan đây là công trình nghiên cứu của riêng tôi dưới sự hướng dẫn của giảng viên hướng dẫn. Các kết quả nêu trong luận văn là trung thực và chưa từng được công bố trong bất kỳ công trình nào khác. Mọi sự giúp đỡ cho việc thực hiện luận văn này đã được cảm ơn và các thông tin trích dẫn trong luận văn đã được chỉ rõ nguồn gốc.

\chapter*{Lời mở đầu}
\addcontentsline{toc}{chapter}{Lời mở đầu}
Sự bùng nổ của Trí tuệ nhân tạo tạo sinh (Generative AI) đã mở ra những cơ hội chưa từng có trong việc cá nhân hóa giáo dục. Tuy nhiên, các hệ thống Quản lý học tập (LMS) hiện nay tại Việt Nam chủ yếu vẫn đóng vai trò là kho lưu trữ tài liệu tĩnh, thiếu đi tính tương tác thông minh và khả năng hỗ trợ học sinh học tập chủ động.

Dự án này được thực hiện với mong muốn xây dựng một hệ sinh thái học tập "Smart LMS" dành cho cấp trung học. Điểm đột phá của hệ thống là việc ứng dụng kỹ thuật Retrieval-Augmented Generation (RAG) để tạo ra một Trợ lý ảo (AI Tutor) có khả năng hiểu sâu sắc nội dung bài giảng của giáo viên, từ đó phản hồi chính xác thắc mắc của học sinh. Bên cạnh đó, hệ thống tích hợp các công cụ giám sát thi cử dựa trên AI nhằm đảm bảo tính liêm chính trong môi trường học tập trực tuyến.

\newpage
\tableofcontents 
\newpage
\listoffigures
\newpage
\listoftables

% ======================================================
% CHƯƠNG 1: MỞ ĐẦU
% ======================================================
\newpage
\pagenumbering{arabic}
\chapter{MỞ ĐẦU}

\section{Lý do chọn đề tài}
Trong kỷ nguyên giáo dục 4.0, vai trò của giáo viên đang dịch chuyển từ người truyền thụ kiến thức sang người điều phối học tập. Tuy nhiên, khối lượng công việc hành chính và việc theo sát từng học sinh trong lớp học trực tuyến là một thách thức lớn. Hệ thống LMS thông minh cần phải giải quyết được bài toán giảm tải cho giáo viên và tăng tính tự học cho học sinh.

\section{Mục tiêu nghiên cứu}
\begin{itemize}
    \item Thiết kế kiến trúc hệ thống LMS đa vai trò (Admin, Teacher, Student, Parent).
    \item Hiện thực hóa module AI Tutor hỗ trợ học tập dựa trên cơ sở dữ liệu vector.
    \item Xây dựng quy trình tự động hóa đánh giá năng lực học sinh qua AI.
    \item Đảm bảo an ninh và tính liêm chính học thuật qua hệ thống chống gian lận.
\end{itemize}

\section{Đối tượng và phạm vi nghiên cứu}
\begin{itemize}
    \item \textbf{Đối tượng:} Quy trình quản lý và hỗ trợ học tập tại các trường trung học.
    \item \textbf{Phạm vi:} Xây dựng ứng dụng Web dựa trên Next.js và tích hợp Google Gemini API.
\end{itemize}

% ======================================================
% CHƯƠNG 2: CƠ SỞ LÝ THUYẾT VÀ CÔNG NGHỆ
% ======================================================
\chapter{CƠ SỞ LÝ THUYẾT VÀ CÔNG NGHỆ}

\section{Tổng quan nền tảng công nghệ}
Hệ thống \textbf{EduVerse} được hiện thực hóa dưới dạng ứng dụng Web theo mô hình full-stack, trong đó lớp giao diện và lớp xử lý nghiệp vụ (API) được tổ chức thống nhất. Nhóm công nghệ trọng tâm gồm: Next.js (App Router) cho kiến trúc web hiện đại \cite{nextjs}, NextAuth.js cho xác thực và quản lý phiên đăng nhập \cite{nextauth}, Prisma ORM cho truy cập dữ liệu \cite{prisma}, PostgreSQL cho lưu trữ quan hệ \cite{postgresql}, pgvector cho truy xuất tương đồng vector phục vụ RAG \cite{pgvector}, Supabase Storage cho lưu trữ tệp nộp bài \cite{supabase}, và Gemini API cho các tác vụ AI (embedding và sinh nội dung) \cite{gemini}.

\begin{table}[htbp]
\centering
\small
\begin{tabular}{|p{3.4cm}|p{5.1cm}|p{5.1cm}|}
\hline
\textbf{Công nghệ (phiên bản)} & \textbf{Vai trò trong hệ thống} & \textbf{Lý do lựa chọn} \\ \hline
Next.js App Router (14.2.33) \cite{nextjs} & Full-stack Web framework; routing, rendering, API Routes & Thống nhất UI và API trong cùng codebase; hỗ trợ triển khai logic nhạy cảm phía server; tối ưu hiệu năng và bảo mật \\ \hline
NextAuth.js (4.24.11) \cite{nextauth} & Xác thực người dùng, quản lý phiên đăng nhập (JWT), RBAC & Hỗ trợ đa cơ chế đăng nhập (Credentials, OAuth) và cho phép kiểm soát phiên/role nhất quán ở middleware và API \\ \hline
Prisma ORM (6.19.0) \cite{prisma} & Truy cập dữ liệu type-safe, migrations, ánh xạ mô hình dữ liệu & Giảm lỗi truy vấn, tăng tính nhất quán và hỗ trợ mở rộng schema có kiểm soát \\ \hline
PostgreSQL \cite{postgresql} & Cơ sở dữ liệu quan hệ lưu dữ liệu nghiệp vụ & Đảm bảo ACID, ổn định và phù hợp dữ liệu có quan hệ phức tạp (khóa học, bài tập, sự kiện thi) \\ \hline
pgvector \cite{pgvector} & Lưu embedding và truy vấn tương đồng vector phục vụ RAG & Cho phép truy xuất ngữ nghĩa ngay trên Postgres, thống nhất hạ tầng dữ liệu \\ \hline
Supabase Storage (2.76.1) \cite{supabase} & Lưu trữ tệp nộp bài, cấp signed URL & Tách tải lưu trữ file khỏi DB, hỗ trợ truy cập an toàn theo thời hạn \\ \hline
Gemini API (\texttt{@google/generative-ai} 0.24.1) \cite{gemini} & Tạo embedding và sinh nội dung (AI Tutor, tóm tắt hỗ trợ) & Khả năng sinh ngôn ngữ tự nhiên và tạo embedding phục vụ truy xuất/giải thích \\ \hline
SWR (2.3.6) & Fetching/caching dữ liệu phía client (revalidate) & Đơn giản hóa đồng bộ dữ liệu UI, giảm tải gọi lại API và cải thiện trải nghiệm người dùng \\ \hline
Vitest (4.0.15) & Kiểm thử tự động (unit test) & Tối ưu tốc độ chạy test; phù hợp dự án TypeScript/ESM và CI \\ \hline
lucide-react (0.546.0) & Bộ biểu tượng UI cho dashboard & Đồng bộ thiết kế icon, dễ mở rộng và tái sử dụng ở nhiều portal \\ \hline
\end{tabular}
\caption{Tóm tắt Tech Stack sử dụng trong hệ thống EduVerse}
\label{tab:tech-stack}
\end{table}

 \begin{table}[htbp]
 \centering
 \small
 \begin{tabular}{|p{3cm}|p{5.3cm}|p{5.3cm}|}
 \hline
 \textbf{Tiêu chí} & \textbf{RAG \cite{rag}} & \textbf{LLM thuần} \\ \hline
 Nguồn tri thức & Dựa trên tài liệu nội bộ (bài giảng) được truy xuất theo câu hỏi & Chủ yếu dựa trên tri thức đã học trong quá trình huấn luyện \\ \hline
 Tính kiểm chứng & Có thể truy vết theo đoạn truy xuất; dễ giải thích tại sao trả lời như vậy & Khó truy vết nguồn; dễ sinh nội dung không có trong tài liệu \\ \hline
 Rủi ro "ảo giác" & Thấp hơn do bị ràng buộc bởi ngữ cảnh truy xuất & Cao hơn, đặc biệt với câu hỏi đặc thù nội dung lớp học \\ \hline
 Chi phí cập nhật tri thức & Cập nhật bằng cách thay tài liệu/embedding (không cần huấn luyện lại) & Thường cần fine-tune hoặc chờ model mới để cập nhật tri thức \\ \hline
 Phù hợp giáo dục & Phù hợp khi cần bám sát học liệu và chuẩn hóa nội dung & Phù hợp cho gợi ý chung, nhưng cần kiểm soát chặt khi dùng như nguồn kiến thức \\ \hline
 \end{tabular}
 \caption{So sánh RAG và LLM thuần trong bối cảnh hệ thống học tập}
 \end{table}

 \section{Kiến trúc tổng thể hệ thống}
 Về mặt kiến trúc, EduVerse có thể xem như một hệ thống gồm bốn lớp chính:
 \begin{itemize}
     \item \textbf{Lớp giao diện (Presentation):} các trang dashboard cho học sinh/giáo viên, tập trung vào thao tác học tập, làm bài và theo dõi kết quả.
     \item \textbf{Lớp dịch vụ ứng dụng (Application/API):} các API Routes xử lý nghiệp vụ (xác thực, nộp bài, ghi sự kiện thi, gọi AI Tutor, tóm tắt chống gian lận), đóng vai trò ranh giới bảo mật và kiểm soát truy cập.
     \item \textbf{Lớp dữ liệu (Data):} PostgreSQL lưu dữ liệu quan hệ, kết hợp pgvector để truy vấn vector; Supabase Storage lưu tệp đính kèm.
     \item \textbf{Lớp dịch vụ AI (External AI Service):} Gemini API đảm nhiệm embedding và sinh phản hồi.
 \end{itemize}
 Trong bối cảnh Next.js, các API Routes và logic truy xuất dữ liệu được thực thi phía server, giúp đảm bảo các tác vụ nhạy cảm (khoá API, truy vấn dữ liệu) không bị lộ ra phía client \cite{nextjs}.

 \section{Kiến trúc Web: Next.js App Router và React}
 Next.js App Router cung cấp cơ chế định tuyến theo thư mục và hỗ trợ Server Components, giúp tách bạch phần render phía server và tương tác phía client. Trong EduVerse, API Routes được dùng để đóng gói các nghiệp vụ nhạy cảm (ví dụ gọi AI, truy cập cơ sở dữ liệu), qua đó hạn chế lộ khóa dịch vụ và giảm tải cho phía client \cite{nextjs}.

 Ở cấp độ triển khai, App Router giúp thống nhất các luồng:
 \begin{itemize}
     \item \textbf{SSR/Server Components:} phù hợp khi cần render dữ liệu theo người dùng (ví dụ thông tin lớp học, bài tập), giảm thời gian chờ nhờ trả về HTML đã có dữ liệu.
     \item \textbf{Client Components:} xử lý tương tác trực tiếp (làm bài kiểm tra, thao tác nộp bài, theo dõi trạng thái) và các hành vi cần bắt sự kiện theo thời gian thực.
     \item \textbf{API Routes:} cung cấp endpoint thống nhất cho client, đồng thời là nơi áp dụng các chính sách bảo mật (xác thực, phân quyền, giới hạn tần suất).
 \end{itemize}

 \section{Xác thực và phân quyền: NextAuth.js}
 Hệ thống sử dụng NextAuth.js để hiện thực hóa đăng nhập và quản lý phiên làm việc của người dùng. Cách tiếp cận này cho phép tích hợp nhiều nhà cung cấp đăng nhập (ví dụ OAuth) và đồng thời hỗ trợ cơ chế Credentials khi cần. Dữ liệu phiên (session) được sử dụng để thực thi phân quyền theo vai trò (giáo viên, học sinh, quản trị, phụ huynh) trong các API và luồng điều hướng \cite{nextauth}.

 Về mô hình triển khai, NextAuth.js cung cấp cơ chế quản lý phiên dựa trên JWT hoặc session lưu trong cơ sở dữ liệu. Khi người dùng đăng nhập, hệ thống tạo thông tin phiên để:
 \begin{itemize}
     \item định danh người dùng (id/email);
     \item gắn \textbf{vai trò (role)} để kiểm soát truy cập chức năng;
     \item đảm bảo tính nhất quán khi truy cập các API Routes.
 \end{itemize}

 \subsection{Phân quyền theo vai trò (RBAC) và bảo vệ truy cập}
 EduVerse áp dụng RBAC (Role-Based Access Control) với bốn vai trò \texttt{STUDENT}, \texttt{TEACHER}, \texttt{PARENT}, \texttt{ADMIN}. Điểm khác biệt trong hiện thực của hệ thống là cơ chế \textbf{multi-portal trong cùng một ứng dụng Next.js duy nhất}: mỗi vai trò sử dụng một không gian chức năng riêng dưới các tuyến \texttt{/dashboard/student}, \texttt{/dashboard/teacher}, \texttt{/dashboard/parent}, \texttt{/dashboard/admin}, nhưng vẫn dùng chung cơ chế xác thực và hạ tầng API.

 Để đảm bảo người dùng không truy cập nhầm hoặc cố ý truy cập chéo vai trò, hệ thống triển khai cơ chế phân quyền theo hướng \textbf{phòng thủ nhiều lớp (defense in depth)}:
 \begin{itemize}
     \item \textbf{Tầng phiên (Session/JWT):} Sau đăng nhập, thông tin \texttt{role} và thời điểm xác nhận vai trò \texttt{roleSelectedAt} được đồng bộ vào JWT/session.
     \item \textbf{Tầng điều hướng (Middleware):} chặn truy cập sớm vào các tuyến không phù hợp với vai trò; bắt buộc chọn vai trò trước khi vào portal dựa trên \texttt{roleSelectedAt}; đồng thời chặn cross-role giữa các portal.
     \item \textbf{Tầng API Routes:} kiểm tra phiên/role trước khi truy vấn dữ liệu hoặc trả kết quả, đặc biệt với các API nhạy cảm (admin-only, teacher-only).
 \end{itemize}
 Cách tiếp cận phòng thủ nhiều lớp (defense in depth) giúp giảm rủi ro truy cập trái phép ngay cả khi client bị giả mạo \cite{nextjs,nextauth}.

 \section{Tầng dữ liệu: Prisma ORM và PostgreSQL}
 Prisma đóng vai trò lớp ánh xạ đối tượng--quan hệ (ORM), giúp truy cập dữ liệu thông qua client kiểu tĩnh (type-safe) trong TypeScript, giảm lỗi truy vấn và tăng tính nhất quán khi phát triển \cite{prisma}. Dữ liệu nghiệp vụ cốt lõi (người dùng, khóa học/bài học, bài tập, lần làm bài, sự kiện thi) được lưu trong PostgreSQL nhờ đặc tính ACID, khả năng mở rộng và hệ sinh thái phong phú \cite{postgresql}.

 \section{Cơ sở dữ liệu vector: pgvector}
 Để phục vụ truy xuất ngữ nghĩa cho AI Tutor, EduVerse lưu trữ embedding dưới dạng vector trong PostgreSQL thông qua phần mở rộng pgvector \cite{pgvector}. Việc lưu vector cùng hệ quản trị quan hệ giúp thống nhất hạ tầng dữ liệu, đồng thời cho phép truy vấn tương đồng (similarity search) trực tiếp trên cùng một nguồn dữ liệu.

 \section{Lưu trữ tệp: Supabase Storage}
 Đối với các bài nộp dạng tệp (ví dụ bài tự luận đính kèm), hệ thống sử dụng Supabase Storage để lưu trữ và cấp phát liên kết truy cập an toàn theo thời hạn (signed URL) \cite{supabase}.

 \section{Mô hình ngôn ngữ lớn (LLM) và Gemini API}
 Gemini API được dùng cho hai nhóm tác vụ: (i) \textbf{tạo embedding} cho tài liệu bài giảng và câu hỏi của học sinh, và (ii) \textbf{sinh câu trả lời} dựa trên ngữ cảnh được truy xuất \cite{gemini}.

 \section{Kiến trúc RAG (Retrieval-Augmented Generation)}
 RAG là nền tảng kỹ thuật của AI Tutor, kết hợp truy xuất tri thức từ nguồn dữ liệu nội bộ và sinh câu trả lời bằng mô hình ngôn ngữ. So với cách chỉ dùng LLM thuần túy, RAG giúp giảm hiện tượng "ảo giác" và tăng khả năng kiểm chứng nhờ bám theo tài liệu bài giảng \cite{rag}.

 \section{Ứng dụng AI trong giám sát thi}
 Ngoài AI Tutor, Gemini còn có thể được sử dụng để \textbf{tóm tắt tín hiệu chống gian lận} dựa trên nhật ký sự kiện thi, giúp giáo viên giảm tải khi phải xem nhiều log.

% ======================================================
% CHƯƠNG 3: PHÂN TÍCH VÀ THIẾT KẾ HỆ THỐNG
% ======================================================

\chapter{PHÂN TÍCH VÀ THIẾT KẾ HỆ THỐNG}

\section{Giới thiệu chương}
Chương 3 trình bày phân tích và thiết kế hệ thống \textbf{EduVerse} dựa trên hiện thực triển khai. Nội dung tập trung làm rõ đối tượng sử dụng, yêu cầu chức năng/phi chức năng và thiết kế các thành phần cốt lõi. Trọng tâm thiết kế được nhấn mạnh ở hai mô-đun: \textbf{AI Tutor theo kiến trúc RAG} và \textbf{giám sát thi/chống gian lận dựa trên event log kết hợp AI tổng hợp}.

\section{Phân tích hệ thống}
\subsection{Đối tượng sử dụng (Actor) và vai trò (Role)}
EduVerse phục vụ các tác nhân chính:
\begin{itemize}
    \item \textbf{Học sinh (STUDENT):} tham gia lớp, học bài, làm bài tập/kiểm tra, tương tác AI Tutor.
    \item \textbf{Giáo viên (TEACHER):} tạo lớp, quản lý khóa học/bài học, tạo bài tập (Quiz/Essay), theo dõi tiến độ và giám sát thi.
    \item \textbf{Phụ huynh (PARENT):} liên kết với học sinh, theo dõi tiến độ/kết quả và nhận tóm tắt định kỳ.
    \item \textbf{Quản trị viên (ADMIN):} quản trị người dùng và cấu hình hệ thống; theo dõi nhật ký hoạt động.
\end{itemize}

\subsection{Yêu cầu chức năng}
Các yêu cầu chức năng được mô tả theo tác nhân sử dụng chính như sau:
\begin{itemize}
    \item \textbf{Khách (chưa đăng nhập):} đăng ký, đăng nhập, quên/đặt lại mật khẩu.
    \item \textbf{Học sinh:} tham gia lớp; xem bài học và học liệu; làm bài (quiz/essay); nộp bài; nhận thông báo; nhắn tin; tương tác AI Tutor.
    \item \textbf{Giáo viên:} tạo và quản lý lớp học; quản lý khóa học/bài học; tạo bài tập/đề kiểm tra; theo dõi tiến độ và kết quả; giám sát thi dựa trên event log và nhận hỗ trợ tổng hợp bằng AI.
    \item \textbf{Phụ huynh:} liên kết với học sinh; theo dõi tiến độ/kết quả; trao đổi với giáo viên.
    \item \textbf{Quản trị viên:} quản trị người dùng và cấu hình hệ thống; theo dõi nhật ký hoạt động.
\end{itemize}

\subsection{Yêu cầu phi chức năng}
\begin{itemize}
    \item \textbf{Bảo mật và phân quyền:} hệ thống dùng NextAuth (JWT strategy) và middleware điều hướng/phân quyền theo role; các API nhạy cảm giới hạn theo vai trò (ví dụ: teacher-only, admin-only) \cite{nextauth}.
    \item \textbf{Kiểm soát lạm dụng (rate limit):} các API nhạy cảm (reset password, AI Tutor, AI anti-cheat, cập nhật cấu hình hệ thống) áp dụng rate limit theo IP và/hoặc user.
    \item \textbf{Khả năng truy vết:} hệ thống ghi audit log cho các hành vi quan trọng và lưu event log cho giám sát thi.
\end{itemize}

\section{Thiết kế hệ thống}
\subsection{Thiết kế kiến trúc}
EduVerse triển khai theo mô hình \textbf{Client--Server} trong một codebase Next.js: client UI gửi request đến API Routes; API Routes thực thi nghiệp vụ, truy cập dữ liệu qua Prisma và gọi dịch vụ AI.

\begin{figure}[H]
    \centering
    \IfFileExists{../out/docs/luanvan/figures/uml/context-eduverse/EduVerse_System_Context.png}{
        \includegraphics[width=0.95\textwidth]{../out/docs/luanvan/figures/uml/context-eduverse/EduVerse_System_Context.png}
    }{
        \IfFileExists{out/docs/luanvan/figures/uml/context-eduverse/EduVerse_System_Context.png}{
            \includegraphics[width=0.95\textwidth]{out/docs/luanvan/figures/uml/context-eduverse/EduVerse_System_Context.png}
        }{
            \IfFileExists{docs/luanvan/figures/uml/EduVerse_System_Context.png}{
                \includegraphics[width=0.95\textwidth]{docs/luanvan/figures/uml/EduVerse_System_Context.png}
            }{
                \IfFileExists{figures/uml/EduVerse_System_Context.png}{
                    \includegraphics[width=0.95\textwidth]{figures/uml/EduVerse_System_Context.png}
                }{
                    \framebox{\parbox{0.95\textwidth}{\centering\vspace{1cm}Context Diagram (PlantUML PNG)\vspace{1cm}}}
                }
            }
        }
    }
    \caption{Sơ đồ bối cảnh hệ thống EduVerse}
    \label{fig:context-eduverse}
\end{figure}

\begin{figure}[H]
    \centering
    \IfFileExists{../out/docs/luanvan/figures/uml/component-architecture/EduVerse_Component_Architecture.png}{
        \includegraphics[width=0.95\textwidth]{../out/docs/luanvan/figures/uml/component-architecture/EduVerse_Component_Architecture.png}
    }{
        \IfFileExists{out/docs/luanvan/figures/uml/component-architecture/EduVerse_Component_Architecture.png}{
            \includegraphics[width=0.95\textwidth]{out/docs/luanvan/figures/uml/component-architecture/EduVerse_Component_Architecture.png}
        }{
            \IfFileExists{docs/luanvan/figures/uml/EduVerse_Component_Architecture.png}{
                \includegraphics[width=0.95\textwidth]{docs/luanvan/figures/uml/EduVerse_Component_Architecture.png}
            }{
                \IfFileExists{figures/uml/EduVerse_Component_Architecture.png}{
                    \includegraphics[width=0.95\textwidth]{figures/uml/EduVerse_Component_Architecture.png}
                }{
                    \framebox{\parbox{0.95\textwidth}{\centering\vspace{1cm}Component/Architecture Diagram (PlantUML PNG)\vspace{1cm}}}
                }
            }
        }
    }
    \caption{Kiến trúc tổng thể hệ thống EduVerse}
    \label{fig:component-architecture}
\end{figure}

\subsection{Thiết kế Use Case}
\Needspace{0.9\textheight}
\subsubsection{Use Case tổng thể hệ thống}
\begin{figure}[H]
    \centering
    \IfFileExists{../out/docs/luanvan/figures/uml/usecase-overall/usecase-overall.png}{
        \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{../out/docs/luanvan/figures/uml/usecase-overall/usecase-overall.png}
    }{
        \IfFileExists{out/docs/luanvan/figures/uml/usecase-overall/usecase-overall.png}{
            \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{out/docs/luanvan/figures/uml/usecase-overall/usecase-overall.png}
        }{
            \IfFileExists{docs/luanvan/figures/uml/usecase-overall.png}{
                \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{docs/luanvan/figures/uml/usecase-overall.png}
            }{
                \IfFileExists{figures/uml/usecase-overall.png}{
                    \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{figures/uml/usecase-overall.png}
                }{
                    \framebox{\parbox{0.95\textwidth}{\centering\vspace{1cm}Use Case Diagram (PlantUML PNG)\vspace{1cm}}}
                }
            }
        }
    }
    \caption{Use Case tổng thể hệ thống EduVerse}
    \label{fig:usecase-overall}
\end{figure}

\Needspace{0.9\textheight}
\subsubsection{Use Case module giám sát thi và chống gian lận}
\begin{figure}[H]
    \centering
    \IfFileExists{../out/docs/luanvan/figures/uml/usecase-anti-cheat/usecase-anti-cheat.png}{
        \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{../out/docs/luanvan/figures/uml/usecase-anti-cheat/usecase-anti-cheat.png}
    }{
        \IfFileExists{out/docs/luanvan/figures/uml/usecase-anti-cheat/usecase-anti-cheat.png}{
            \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{out/docs/luanvan/figures/uml/usecase-anti-cheat/usecase-anti-cheat.png}
        }{
            \IfFileExists{docs/luanvan/figures/uml/usecase-anti-cheat.png}{
                \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{docs/luanvan/figures/uml/usecase-anti-cheat.png}
            }{
                \IfFileExists{figures/uml/usecase-anti-cheat.png}{
                    \includegraphics[width=0.95\textwidth,height=0.85\textheight,keepaspectratio]{figures/uml/usecase-anti-cheat.png}
                }{
                    \framebox{\parbox{0.95\textwidth}{\centering\vspace{1cm}Use Case Diagram (PlantUML PNG)\vspace{1cm}}}
                }
            }
        }
    }
    \caption{Use Case tổng quan module giám sát thi và chống gian lận}
    \label{fig:usecase-anti-cheat}
\end{figure}

\subsection{Thiết kế cơ sở dữ liệu}
Hệ thống sử dụng Prisma ORM kết nối PostgreSQL \cite{prisma,postgresql}. Hình \ref{fig:db-core} minh họa mối quan hệ giữa các thực thể dữ liệu cốt lõi; Bảng \ref{tab:db-core} tóm tắt các nhóm dữ liệu và vai trò tương ứng.

\begin{figure}[H]
    \centering
    \IfFileExists{docs/luanvan/figures/uml/EduVerse_DB_Core.png}{
        \includegraphics[height=0.9\textheight,keepaspectratio]{docs/luanvan/figures/uml/EduVerse_DB_Core.png}
    }{
        \IfFileExists{figures/uml/EduVerse_DB_Core.png}{
            \includegraphics[height=0.9\textheight,keepaspectratio]{figures/uml/EduVerse_DB_Core.png}
        }{
            \IfFileExists{../../out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}{
                \includegraphics[height=0.9\textheight,keepaspectratio]{../../out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}
            }{
                \IfFileExists{../out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}{
                    \includegraphics[height=0.9\textheight,keepaspectratio]{../out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}
                }{
                    \IfFileExists{out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}{
                        \includegraphics[height=0.9\textheight,keepaspectratio]{out/docs/luanvan/figures/uml/db-core/EduVerse_DB_Core.png}
                    }{
                        \framebox{\parbox{0.95\textwidth}{\centering\vspace{1cm}Database Diagram (PlantUML PNG)\vspace{1cm}}}
                    }
                }
            }
        }
    }
    \caption{Sơ đồ cơ sở dữ liệu cốt lõi của hệ thống EduVerse}
    \label{fig:db-core}
\end{figure}

\begin{table}[H]
\centering
\small
\begin{tabular}{|p{3.2cm}|p{11.7cm}|}
\hline
\textbf{Nhóm dữ liệu} & \textbf{Vai trò} \\ \hline
Người dùng & Các bảng: \texttt{users} (\texttt{User}). Lưu thông tin tài khoản, vai trò (\texttt{UserRole}), thời điểm chọn vai trò (\texttt{roleSelectedAt}). \\ \hline
Khôi phục mật khẩu & Các bảng: \texttt{password\_resets} (\texttt{PasswordReset}). Lưu mã xác nhận đặt lại mật khẩu, thời hạn (\texttt{expires}) và trạng thái hoàn thành (\texttt{completed}). \\ \hline
Lớp học & Các bảng: \texttt{classrooms}, \texttt{classroom\_students}. Tổ chức lớp học, liên kết học sinh--lớp. \\ \hline
Khóa học/bài học & Các bảng: \texttt{courses}, \texttt{lessons}, \texttt{lesson\_attachments}. Lưu nội dung bài học và tệp đính kèm; là nguồn tri thức cho RAG Tutor. \\ \hline
RAG embedding & Bảng: \texttt{lesson\_embedding\_chunks}. Lưu các đoạn (chunk) đã embedding bằng pgvector để truy vấn tương đồng theo Top-$k$ \cite{pgvector}. \\ \hline
Bài tập/quiz & Các bảng: \texttt{assignments}, \texttt{questions}, \texttt{question\_options}. Lưu bài tập dạng ESSAY/QUIZ, cấu trúc câu hỏi và đáp án. \\ \hline
Nộp bài (ESSAY) & Bảng: \texttt{assignment\_submissions}. Lưu bài tự luận dạng nội dung, điểm và phản hồi. \\ \hline
Nộp bài (tệp) & Các bảng: \texttt{submissions}, \texttt{submission\_files}. Lưu metadata tệp nộp bài (\texttt{storagePath}, \texttt{mimeType}, \texttt{sizeBytes}). \\ \hline
Giám sát thi & Các bảng: \texttt{exam\_events}, \texttt{assignment\_attempts}. Lưu nhật ký sự kiện thi (event log) và thông tin attempt. \\ \hline
Chat & Các bảng: \texttt{conversations}, \texttt{conversation\_participants}, \texttt{messages}, \texttt{chat\_attachments}. Lưu hội thoại và tin nhắn. \\ \hline
Hệ thống/Audit & Các bảng: \texttt{system\_settings}, \texttt{audit\_logs}. Lưu cấu hình hệ thống và nhật ký hoạt động phục vụ truy vết. \\ \hline
\end{tabular}
\caption{Các bảng dữ liệu cốt lõi trong hệ thống EduVerse }
\label{tab:db-core}
\end{table}

% ======================================================
% CHƯƠNG 4: HIỆN THỰC HÓA HỆ THỐNG
% ======================================================

\chapter{HIỆN THỰC HÓA HỆ THỐNG}

\section{Mô-đun AI Tutor theo kiến trúc RAG}
Phần này trình bày chi tiết quy trình hiện thực AI Tutor trong EduVerse theo hướng Retrieval-Augmented Generation (RAG). Trong phiên bản triển khai, hệ thống \textbf{không sử dụng LlamaIndex}, mà xây dựng pipeline nội bộ để kiểm soát việc chunking, indexing và truy vấn ngữ nghĩa trên cùng hạ tầng PostgreSQL.

\subsection{Chuẩn bị dữ liệu và chunking nội dung bài học}
Nguồn tri thức của AI Tutor là dữ liệu bài học (lesson) do giáo viên biên soạn. Trước khi tạo embedding, hệ thống thực hiện chunking nhằm cân bằng giữa: (i) độ dài ngữ cảnh đủ lớn để giữ ý nghĩa, và (ii) giới hạn độ dài để đảm bảo hiệu quả tính toán embedding.

Cụ thể, nội dung lesson được ghép theo dạng \texttt{\# <title>\textbackslash n\textbackslash n<content>} và đưa qua hàm chunking. Thuật toán ưu tiên tách theo đoạn (phân cách bởi \texttt{\textbackslash n\textbackslash n}); nếu một đoạn vẫn vượt ngưỡng, hệ thống fallback sang tách theo từ để đảm bảo mỗi chunk không vượt quá \texttt{maxChars}. Tham số mặc định \texttt{maxChars=1200} được sử dụng trong quá trình indexing.

\subsection{Tạo embedding bằng Gemini Embedding}
Đối với mỗi chunk, hệ thống gọi Gemini Embedding model \texttt{gemini-embedding-001} \cite{gemini} để tạo vector biểu diễn ngữ nghĩa. Embedding được tiêu chuẩn hóa về số chiều \texttt{1536}. Trong hiện thực, chunk bài học sử dụng task type \texttt{RETRIEVAL\_DOCUMENT} và câu hỏi học sinh sử dụng \texttt{RETRIEVAL\_QUERY} để tối ưu truy vấn.

Hệ thống có cơ chế retry với backoff (tối đa theo cấu hình) cho các lỗi tạm thời (ví dụ 429/rate limit), đồng thời kiểm tra ràng buộc số chiều embedding để tránh ghi dữ liệu sai định dạng.

\subsection{Lưu trữ embedding và truy vấn vector similarity bằng pgvector}
Embedding sau khi tạo được lưu vào bảng \texttt{lesson\_embedding\_chunks}. Mỗi chunk được định danh theo cặp khóa \texttt{(lessonId, chunkIndex)}; hệ thống dùng \texttt{contentHash} (SHA-256) để phát hiện chunk không đổi và \textbf{bỏ qua indexing} khi nội dung giữ nguyên, giúp giảm chi phí gọi API embedding.

Khi học sinh đặt câu hỏi, hệ thống:
\begin{enumerate}
    \item tạo embedding cho câu hỏi;
    \item truy vấn các chunk gần nhất theo khoảng cách vector trong PostgreSQL;
    \item ghép các chunk Top-$k$ vào prompt làm ngữ cảnh trả lời.
\end{enumerate}

Truy vấn similarity sử dụng toán tử khoảng cách của pgvector dưới dạng \texttt{("embedding" <=> queryVector::vector) AS distance}, sau đó sắp xếp \texttt{ORDER BY distance ASC} và lấy \texttt{LIMIT topK}. Kết quả là danh sách các đoạn nguồn được dùng để ràng buộc câu trả lời của AI Tutor, nhằm giảm hiện tượng “ảo giác” \cite{rag}.

\subsection{Tổ chức pipeline indexing (teacher-trigger và cron)}
Hệ thống hỗ trợ hai cách kích hoạt indexing:
\begin{itemize}
    \item \textbf{Teacher-trigger:} giáo viên gọi endpoint indexing theo khóa học để tạo hoặc làm mới embedding khi cập nhật lesson.
    \item \textbf{Cron indexing:} tiến trình định kỳ quét lesson cập nhật và thực hiện indexing, có xác thực bằng bí mật cron.
\end{itemize}
Cả hai luồng đều dùng chung hàm indexing, bảo đảm tính nhất quán về chunking, embedding và cách ghi dữ liệu.

\subsection{Lý do chọn pgvector thay vì Vector DB tách biệt}
EduVerse ưu tiên sử dụng pgvector \cite{pgvector} thay vì một vector database tách biệt nhằm đạt các mục tiêu kiến trúc sau:
\begin{itemize}
    \item \textbf{Thống nhất hạ tầng dữ liệu:} dữ liệu quan hệ và dữ liệu vector cùng nằm trong PostgreSQL \cite{postgresql}.
    \item \textbf{Tính nhất quán và quản trị:} giảm số lượng hệ thống phụ trợ, giảm độ phức tạp vận hành và rủi ro lệch dữ liệu.
    \item \textbf{Đơn giản hóa backup/audit:} một nguồn dữ liệu trung tâm giúp sao lưu, phục hồi và truy vết dễ hơn.
\end{itemize}

\section{Hệ thống đánh giá và giám sát thi cử}
\subsection{Cơ chế tự động chấm bài}
Đối với bài tự luận (ESSAY), hệ thống hỗ trợ giáo viên bằng cơ chế gợi ý chấm điểm: server lấy nội dung bài nộp, kết hợp thông tin đề bài và rubric, sau đó gọi Gemini để sinh gợi ý điểm số và nhận xét. Các API AI được áp dụng giới hạn tần suất (rate limit) nhằm giảm nguy cơ lạm dụng tài nguyên dịch vụ AI.

\subsection{Phát hiện hành vi đáng ngờ và tổng hợp báo cáo chống gian lận (Anti-cheat)}
Trong EduVerse, dữ liệu chống gian lận được thu thập dưới dạng \textbf{event log} trong quá trình học sinh làm bài quiz. Các sự kiện được ghi nhận tại giao diện thi (client) và lưu về server để phục vụ phân tích.

\subsubsection{Thu thập dữ liệu: ánh xạ hành vi trình duyệt sang exam events}
Các tín hiệu gian lận trọng yếu trong hiện thực bao gồm:
\begin{itemize}
    \item \textbf{Chuyển tab (visibilitychange):} khi \texttt{document.hidden = true}, hệ thống ghi event \texttt{TAB\_SWITCH\_DETECTED} với nguồn \texttt{visibilitychange}.
    \item \textbf{Mất focus cửa sổ (blur):} khi \texttt{window.blur} xảy ra, hệ thống cũng ghi \texttt{TAB\_SWITCH\_DETECTED} với nguồn \texttt{window\_blur}.
    \item \textbf{Clipboard/context menu:} hệ thống chặn thao tác copy/paste và ghi event \texttt{COPY\_PASTE\_ATTEMPT} với nguồn \texttt{contextmenu} hoặc phím tắt tương ứng.
    \item \textbf{Thoát fullscreen:} khi bắt buộc fullscreen và học sinh thoát fullscreen, hệ thống ghi event \texttt{FULLSCREEN\_EXIT}.
\end{itemize}

\subsubsection{Thuật toán tính điểm: suspicionScore theo rule-based scoring}
Server tính điểm nghi ngờ \texttt{suspicionScore} theo cơ chế rule-based, ánh xạ từng loại event sang một rule với trọng số và mức trần điểm. Mỗi rule có dạng:
\begin{quote}
\texttt{points = min(maxPoints, count * pointsPerHit)}
\end{quote}
Điểm tổng được chặn trong khoảng $[0,100]$. Trong hiện thực, các rule trọng yếu và tham số tương ứng bao gồm:
\begin{itemize}
    \item \textbf{Thoát fullscreen:} \texttt{pointsPerHit=20}, \texttt{maxPoints=40}.
    \item \textbf{Chuyển tab:} \texttt{pointsPerHit=12}, \texttt{maxPoints=60}.
    \item \textbf{Clipboard/context menu:} \texttt{pointsPerHit=8}, \texttt{maxPoints=24}.
    \item \textbf{Phím tắt nghi ngờ:} \texttt{pointsPerHit=6}, \texttt{maxPoints=18}.
\end{itemize}
Từ tổng điểm, hệ thống suy ra mức rủi ro \texttt{riskLevel} (low/medium/high) để hỗ trợ giáo viên ra quyết định.

\subsubsection{Chuyển đổi logs thành báo cáo ngôn ngữ tự nhiên bằng AI}
Sau khi có kết quả rule-based (\texttt{suspicionScore}, \texttt{riskLevel} và \texttt{breakdown}), hệ thống gọi Gemini để sinh báo cáo ngắn gọn cho giáo viên theo dạng JSON cấu trúc. Đầu vào của mô hình AI là payload đã được server-side giới hạn và làm an toàn (giới hạn số events, chuẩn hóa kiểu dữ liệu), và đầu ra được parse/validate bằng ràng buộc schema để tránh nội dung sai định dạng.

\section{Giao diện người dùng (UI/UX)}
EduVerse sử dụng Tailwind CSS và các thành phần UI tái sử dụng để xây dựng dashboard theo vai trò. Việc tổ chức UI theo multi-portal giúp đảm bảo mỗi nhóm người dùng (học sinh/giáo viên/phụ huynh/quản trị) có luồng thao tác rõ ràng, đồng thời giảm nguy cơ truy cập nhầm chức năng.

\section{Đề xuất và bổ sung biểu đồ (Mermaid) cho Chương 4}
Phần này cung cấp ba biểu đồ dạng Mermaid để phục vụ mô tả chi tiết quy trình trong chương hiện thực hóa. Mã Mermaid được trình bày dưới dạng listing để có thể tái sử dụng.

\subsection{Biểu đồ trình tự: Nộp bài dạng tệp}
\begin{lstlisting}[caption={Sequence Diagram (Mermaid): Quy trình nộp bài dạng tệp},label={lst:seq-file-submission}]
sequenceDiagram
  autonumber
  actor S as Student (Browser)
  participant SB as Supabase Storage
  participant API as Next.js API (/api/submissions)
  participant DB as PostgreSQL (Prisma)

  S->>SB: Upload file to bucket (submissions/{assignmentId}/{studentId}/...)
  SB-->>S: Upload OK (storagePath)

  S->>API: POST /api/submissions {assignmentId, files[], status=draft}
  API->>API: Validate JWT + role=STUDENT
  API->>API: Validate storagePath (prefix, no '..', match studentId)
  API->>DB: Upsert submission + replace submission_files metadata
  DB-->>API: OK (submissionId)
  API-->>S: 201 Created {submissionId}

  S->>API: PUT /api/submissions/{submissionId} (confirm submit)
  API->>DB: Check max_attempts + current submission status
  DB-->>API: OK
  API-->>S: 200 OK
\end{lstlisting}

\subsection{Biểu đồ luồng: RAG Tutor}
\begin{lstlisting}[caption={Flow Diagram (Mermaid): Quy trình RAG Tutor},label={lst:flow-rag}]
flowchart TD
  A[Student question] --> B[API /api/ai/tutor/chat]
  B --> C{Auth + role=STUDENT}
  C -->|OK| D{Student in classroom?}
  D -->|OK| E[Create query embedding (gemini-embedding-001)]
  E --> F[Vector search in Postgres: embedding <=> queryVec]
  F --> G[Top-k chunks as sources]
  G --> H[Build prompt: instruction + sources + history]
  H --> I[Gemini generate answer]
  I --> J[Return answer + sources]
  C -->|Fail| X[401/403]
  D -->|Fail| Y[403 Forbidden]
\end{lstlisting}

\subsection{Biểu đồ logic: Anti-cheat scoring và AI summary}
\begin{lstlisting}[caption={Flow Diagram (Mermaid): Anti-cheat scoring và AI summary},label={lst:flow-anti-cheat}]
flowchart TD
  A[Exam UI events: visibilitychange, blur, contextmenu, fullscreen exit] --> B[Store exam_events]
  B --> C[Teacher requests /api/ai/anti-cheat/summary]
  C --> D{Auth + role=TEACHER + isOwner(assignment)}
  D -->|OK| E[Fetch events (<=250) ordered by time]
  E --> F[Compute suspicionScore (rule-based)]
  F --> G[Build safe payload: score + breakdown + event snapshots]
  G --> H[Gemini generate JSON summary]
  H --> I[Validate JSON by schema]
  I --> J[Return report to Teacher]
  D -->|Fail| X[401/403]
\end{lstlisting}

% ======================================================
% CHƯƠNG 5: ĐÁNH GIÁ VÀ THỬ NGHIỆM
% ======================================================

\chapter{ĐÁNH GIÁ VÀ THỬ NGHIỆM}

\section{Đánh giá độ chính xác của AI Tutor}
Thử nghiệm với các bộ câu hỏi mẫu và so sánh câu trả lời của AI với nội dung bài giảng thực tế.

\section{Đánh giá hiệu năng hệ thống}
Phân tích thời gian phản hồi khi truy xuất Vector và khả năng chịu tải của API Routes.

% ======================================================
% CHƯƠNG 6: KẾT LUẬN VÀ HƯỚNG PHÁT TRIỂN
% ======================================================

\chapter{KẾT LUẬN VÀ HƯỚNG PHÁT TRIỂN}

\section{Kết quả đạt được}
Hệ thống đã giải quyết được vấn đề cá nhân hóa hỗ trợ học tập và giúp giáo viên tự động hóa các công việc lặp đi lặp lại.

\section{Hướng phát triển tương lai}
Tích hợp nhận diện khuôn mặt để xác thực danh tính học sinh khi thi và mở rộng ứng dụng trên nền tảng di động.

% ======================================================
% TÀI LIỆU THAM KHẢO
% ======================================================
\begin{thebibliography}{99}
\addcontentsline{toc}{chapter}{Tài liệu tham khảo}
\bibitem{nextjs} Vercel, "Next.js 14 Documentation," 2024. [Online]. Available: \url{https://nextjs.org/docs}.
\bibitem{nextauth} NextAuth.js, "NextAuth.js Documentation," 2024. [Online]. Available: \url{https://next-auth.js.org}.
\bibitem{prisma} Prisma, "Prisma Documentation," 2024. [Online]. Available: \url{https://www.prisma.io/docs}.
\bibitem{postgresql} The PostgreSQL Global Development Group, "PostgreSQL Documentation," 2024. [Online]. Available: \url{https://www.postgresql.org/docs/}.
\bibitem{pgvector} pgvector, "pgvector: Open-source vector similarity search for Postgres," 2024. [Online]. Available: \url{https://github.com/pgvector/pgvector}.
\bibitem{supabase} Supabase, "Supabase Documentation," 2024. [Online]. Available: \url{https://supabase.com/docs}.
\bibitem{plantuml} PlantUML, "PlantUML Documentation," 2024. [Online]. Available: \url{https://plantuml.com/}.
\bibitem{gemini} Google DeepMind, "Gemini: A Family of Highly Capable Multimodal Models," 2023.
\bibitem{rag} Lewis, P., et al., "Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks," NeurIPS, 2020.
\end{thebibliography}

\end{document}